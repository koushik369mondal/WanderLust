<%- include('../layouts/boilerplate') %>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="fa-solid fa-lightbulb me-3"></i>
                    Smart Travel Recommendations
                </h1>
                <p class="lead text-muted">
                    <% if (user) { %>
                        Discover destinations tailored to your travel preferences
                    <% } else { %>
                        Explore our most popular destinations
                    <% } %>
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="fa-solid fa-robot me-3 fs-4"></i>
                            <div>
                                <strong>AI-Powered Recommendations:</strong>
                                <% if (user) { %>
                                    Based on your review history, ratings, and travel preferences
                                <% } else { %>
                                    Based on overall popularity, ratings, and user reviews
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Grid -->
            <div class="row g-4">
                <% if (recommendations && recommendations.length > 0) { %>
                    <% recommendations.forEach((listing, index) => { %>
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm recommendation-card" data-aos="fade-up" data-aos-delay="<%= index * 100 %>">
                                <!-- Image -->
                                <div class="position-relative">
                                    <% if (listing.image && listing.image.url) { %>
                                        <img src="<%= listing.image.url %>" 
                                             class="card-img-top recommendation-image" 
                                             alt="<%= listing.title %>"
                                             style="height: 250px; object-fit: cover;">
                                    <% } else { %>
                                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" 
                                             style="height: 250px;">
                                            <i class="fa-solid fa-image text-muted fs-1"></i>
                                        </div>
                                    <% } %>
                                    
                                    <!-- Recommendation Badge -->
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-success fs-6">
                                            <i class="fa-solid fa-star me-1"></i>
                                            #<%= index + 1 %> Pick
                                        </span>
                                    </div>
                                    
                                    <!-- Category Badge -->
                                    <% if (listing.category) { %>
                                        <div class="position-absolute top-0 start-0 m-2">
                                            <span class="badge bg-primary fs-6">
                                                <i class="fa-solid fa-tag me-1"></i>
                                                <%= listing.category %>
                                            </span>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Card Body -->
                                <div class="card-body d-flex flex-column">
                                    <!-- Title and Location -->
                                    <h5 class="card-title fw-bold text-dark mb-2">
                                        <%= listing.title %>
                                    </h5>
                                    
                                    <div class="text-muted mb-3">
                                        <i class="fa-solid fa-map-marker-alt me-2"></i>
                                        <%= listing.location %><% if (listing.country) { %>, <%= listing.country %><% } %>
                                    </div>

                                    <!-- Rating and Reviews -->
                                    <div class="d-flex align-items-center mb-3">
                                        <% if (listing.avgRating > 0) { %>
                                            <div class="rating-stars me-2">
                                                <% for (let i = 1; i <= 5; i++) { %>
                                                    <% if (i <= Math.floor(listing.avgRating)) { %>
                                                        <i class="fa-solid fa-star text-warning"></i>
                                                    <% } else if (i === Math.ceil(listing.avgRating) && listing.avgRating % 1 !== 0) { %>
                                                        <i class="fa-solid fa-star-half-stroke text-warning"></i>
                                                    <% } else { %>
                                                        <i class="fa-regular fa-star text-warning"></i>
                                                    <% } %>
                                                <% } %>
                                            </div>
                                            <span class="fw-bold text-dark me-2"><%= listing.avgRating.toFixed(1) %></span>
                                        <% } %>
                                        
                                        <% if (listing.reviews && listing.reviews.length > 0) { %>
                                            <span class="text-muted">
                                                (<%= listing.reviews.length %> review<%= listing.reviews.length !== 1 ? 's' : '' %>)
                                            </span>
                                        <% } %>
                                    </div>

                                    <!-- Description -->
                                    <% if (listing.description) { %>
                                        <p class="card-text text-muted mb-3 flex-grow-1">
                                            <%= listing.description.length > 120 ? listing.description.substring(0, 120) + '...' : listing.description %>
                                        </p>
                                    <% } %>

                                    <!-- Price and Features -->
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <% if (listing.price) { %>
                                                <div class="price-section">
                                                    <% if (listing.hasDiscount && listing.discountPrice) { %>
                                                        <span class="text-decoration-line-through text-muted me-2">
                                                            $<%= listing.price %>
                                                        </span>
                                                        <span class="fw-bold text-success fs-5">
                                                            $<%= listing.discountPrice %>
                                                        </span>
                                                        <span class="badge bg-danger ms-2">Sale!</span>
                                                    <% } else { %>
                                                        <span class="fw-bold text-primary fs-5">
                                                            $<%= listing.price %>
                                                        </span>
                                                    <% } %>
                                                    <small class="text-muted d-block">per night</small>
                                                </div>
                                            <% } %>
                                            
                                            <!-- Special Features -->
                                            <div class="special-features">
                                                <% if (listing.isFeatured) { %>
                                                    <span class="badge bg-warning text-dark me-1" title="Featured Listing">
                                                        <i class="fa-solid fa-star"></i>
                                                    </span>
                                                <% } %>
                                                <% if (listing.hasDiscount) { %>
                                                    <span class="badge bg-danger me-1" title="Special Discount">
                                                        <i class="fa-solid fa-percent"></i>
                                                    </span>
                                                <% } %>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="d-grid gap-2">
                                            <a href="/listings/<%= listing._id %>" 
                                               class="btn btn-primary btn-lg">
                                                <i class="fa-solid fa-eye me-2"></i>
                                                View Details
                                            </a>
                                            
                                            <% if (user) { %>
                                                <div class="btn-group" role="group">
                                                    <button type="button" 
                                                            class="btn btn-outline-secondary btn-sm"
                                                            onclick="addToWishlist('<%= listing._id %>')">
                                                        <i class="fa-solid fa-bookmark me-1"></i>
                                                        Save
                                                    </button>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger btn-sm"
                                                            onclick="likeListing('<%= listing._id %>')">
                                                        <i class="fa-solid fa-heart me-1"></i>
                                                        Like
                                                    </button>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <!-- No Recommendations -->
                    <div class="col-12 text-center py-5">
                        <div class="empty-state">
                            <i class="fa-solid fa-compass text-muted mb-4" style="font-size: 4rem;"></i>
                            <h3 class="text-muted mb-3">No Recommendations Available</h3>
                            <p class="text-muted mb-4">
                                We're working on finding the perfect destinations for you.
                            </p>
                            <a href="/listings" class="btn btn-primary btn-lg">
                                <i class="fa-solid fa-search me-2"></i>
                                Explore All Listings
                            </a>
                        </div>
                    </div>
                <% } %>
            </div>

            <!-- Call to Action Section -->
            <% if (recommendations && recommendations.length > 0) { %>
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="card bg-gradient-primary text-white">
                            <div class="card-body text-center py-5">
                                <h3 class="card-title mb-3">
                                    <i class="fa-solid fa-rocket me-2"></i>
                                    Ready for Your Next Adventure?
                                </h3>
                                <p class="card-text mb-4">
                                    <% if (user) { %>
                                        Continue exploring destinations that match your travel style
                                    <% } else { %>
                                        Sign up to get personalized recommendations based on your preferences
                                    <% } %>
                                </p>
                                <div class="d-flex justify-content-center gap-3">
                                    <a href="/listings" class="btn btn-light btn-lg">
                                        <i class="fa-solid fa-compass me-2"></i>
                                        Explore All Destinations
                                    </a>
                                    <% if (!user) { %>
                                        <a href="/signup" class="btn btn-outline-light btn-lg">
                                            <i class="fa-solid fa-user-plus me-2"></i>
                                            Get Personalized Recommendations
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
    .recommendation-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .recommendation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
    }
    
    .recommendation-image {
        transition: transform 0.3s ease;
    }
    
    .recommendation-card:hover .recommendation-image {
        transform: scale(1.05);
    }
    
    .rating-stars {
        font-size: 0.9rem;
    }
    
    .price-section {
        line-height: 1.2;
    }
    
    .special-features .badge {
        font-size: 0.7rem;
    }
    
    .empty-state {
        padding: 3rem 0;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    .recommendation-card .card-img-top {
        position: relative;
        overflow: hidden;
    }
    
    .recommendation-card .badge {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.9) !important;
        color: #000 !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .recommendation-card .badge.bg-success {
        background-color: rgba(40, 167, 69, 0.9) !important;
        color: #fff !important;
    }
    
    .recommendation-card .badge.bg-primary {
        background-color: rgba(0, 123, 255, 0.9) !important;
        color: #fff !important;
    }
</style>

<!-- JavaScript for Interactive Features -->
<script>
    // Add to wishlist functionality
    function addToWishlist(listingId) {
        fetch(`/profile/wishlist/${listingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showToast('Added to wishlist!', 'success');
            } else {
                showToast(data.message || 'Error adding to wishlist', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error adding to wishlist', 'error');
        });
    }
    
    // Like listing functionality
    function likeListing(listingId) {
        fetch(`/listings/${listingId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Liked!', 'success');
            } else {
                showToast(data.message || 'Error liking listing', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error liking listing', 'error');
        });
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove from DOM after hiding
        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    }
    
    // Initialize AOS (Animate On Scroll) if available
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
    }
</script>
