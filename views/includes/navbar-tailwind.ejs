<!-- Premium Glassmorphism Navbar with Tailwind CSS -->
<nav class="tw-glass-dark tw-sticky tw-top-0 tw-z-50 tw-shadow-2xl tw-border-b tw-border-white/10" role="navigation"
    aria-label="Main navigation">
    <div class="tw-max-w-7xl tw-mx-auto tw-px-4 sm:tw-px-6 lg:tw-px-8">
        <div class="tw-flex tw-items-center tw-justify-between tw-h-20 tw-gap-6">

            <!-- Brand Logo -->
            <a href="/listings"
                class="tw-flex tw-items-center tw-gap-2 tw-text-2xl tw-font-bold tw-text-white hover:tw-scale-105 tw-transition-transform tw-duration-300"
                aria-label="WanderLust - Go to home page">
                <i class="fa-regular fa-compass tw-text-aqua tw-animate-spin-slow" aria-hidden="true"></i>
                <span class="tw-bg-gradient-to-r tw-from-gold tw-to-coral tw-bg-clip-text tw-text-transparent">
                    <%= __('wanderlust') %>
                </span>
            </a>

            <!-- Desktop Navigation -->
            <div class="tw-hidden lg:tw-flex tw-items-center tw-gap-6 tw-flex-1 tw-justify-between">

                <!-- Nav Links -->
                <div class="tw-flex tw-items-center tw-gap-4">
                    <a href="/listings"
                        class="tw-text-white tw-font-medium hover:tw-text-aqua tw-transition-colors tw-duration-300 tw-flex tw-items-center tw-gap-2">
                        <i class="fa-regular fa-copy" aria-hidden="true"></i>
                        <span>
                            <%= __('all_listings') %>
                        </span>
                    </a>
                    <a href="/listings/about"
                        class="tw-text-white tw-font-medium hover:tw-text-aqua tw-transition-colors tw-duration-300 tw-flex tw-items-center tw-gap-2">
                        <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
                        <span>
                            <%= __('about') %>
                        </span>
                    </a>

                    <!-- Travel Tools Dropdown (Bootstrap for dropdown functionality) -->
                    <div class="dropdown">
                        <button
                            class="tw-text-white tw-font-medium hover:tw-text-aqua tw-transition-colors tw-duration-300 tw-flex tw-items-center tw-gap-2 tw-bg-transparent tw-border-0"
                            data-bs-toggle="dropdown" aria-expanded="false" id="travelToolsDropdown">
                            <i class="fa-solid fa-tools" aria-hidden="true"></i>
                            <span>Travel Tools</span>
                            <i class="fa-solid fa-chevron-down tw-text-xs"></i>
                        </button>
                        <ul class="dropdown-menu tw-glass-dark tw-border tw-border-white/20 tw-rounded-2xl tw-p-2"
                            aria-labelledby="travelToolsDropdown">
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/trip-planner"><i class="fa-solid fa-route tw-mr-2"></i>Trip Planner</a></li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/packing-list"><i class="fa-solid fa-suitcase tw-mr-2"></i>Packing List</a>
                            </li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/holiday"><i class="fa-solid fa-calendar-days tw-mr-2"></i>Holiday
                                    Calendar</a></li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/listings/compare"><i class="fa-solid fa-balance-scale tw-mr-2"></i>Compare
                                    Destinations</a></li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/trip-planner/mood-fixing"><i class="fa-solid fa-music tw-mr-2"></i>Mood
                                    Fixing</a></li>
                            <li>
                                <hr class="tw-border-white/10">
                            </li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/weather"><i class="fa-solid fa-cloud-sun tw-mr-2"></i>Weather Info</a></li>
                            <li>
                                <hr class="tw-border-white/10">
                            </li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/achievements"><i class="fa-solid fa-trophy tw-mr-2"></i>Achievements</a></li>
                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                    href="/leaderboard"><i class="fa-solid fa-chart-line tw-mr-2"></i>Leaderboard</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Search Bar -->
                <form method="GET" action="/listings"
                    class="tw-search-glass tw-flex tw-items-center tw-px-4 tw-gap-2 tw-max-w-md tw-flex-1" role="search"
                    aria-label="Search destinations">
                    <i class="fa-solid fa-magnifying-glass tw-text-white/60" aria-hidden="true"></i>
                    <input type="search" name="search" id="searchInput" placeholder="<%= __('search_destinations') %>"
                        value="<%= typeof searchQuery !== 'undefined' && searchQuery ? searchQuery : '' %>"
                        class="tw-bg-transparent tw-border-0 tw-text-white tw-placeholder-white/60 tw-outline-none tw-flex-1 tw-py-3"
                        autocomplete="off" aria-label="Search destinations" />
                    <button type="submit" class="tw-btn-gradient tw-text-sm tw-px-4 tw-py-2" aria-label="Submit search">
                        <%= __('search') %>
                    </button>
                </form>
                <div class="search-suggestions tw-glass-dark tw-rounded-2xl tw-mt-2 tw-border tw-border-white/20"
                    id="searchSuggestions" role="listbox" aria-label="Search suggestions"></div>

                <!-- Right Actions -->
                <div class="tw-flex tw-items-center tw-gap-3">

                    <!-- Add New Listing -->
                    <a href="/listings/new"
                        class="tw-btn-glass tw-text-white tw-text-sm tw-px-4 tw-py-2 tw-whitespace-nowrap">
                        <i class="fa-solid fa-plus tw-mr-2" aria-hidden="true"></i>
                        <span class="tw-hidden xl:tw-inline">
                            <%= __('add_new_listing') %>
                        </span>
                        <span class="tw-inline xl:tw-hidden">Add</span>
                    </a>

                    <% if (typeof currentUser==='undefined' || !currentUser) { %>
                        <!-- Login/Signup -->
                        <a href="/login" class="tw-btn-glass tw-text-white tw-text-sm tw-px-4 tw-py-2">
                            <i class="fa-solid fa-sign-in-alt tw-mr-2" aria-hidden="true"></i>
                            <%= __('login') %>
                        </a>
                        <a href="/signup" class="tw-btn-gradient tw-text-sm tw-px-4 tw-py-2">
                            <i class="fa-solid fa-user-plus tw-mr-2" aria-hidden="true"></i>
                            <%= __('signup') %>
                        </a>
                        <% } else { %>
                            <!-- Profile Dropdown -->
                            <div class="dropdown">
                                <button
                                    class="tw-btn-glass tw-text-white tw-text-sm tw-px-4 tw-py-2 tw-flex tw-items-center tw-gap-2"
                                    data-bs-toggle="dropdown" aria-expanded="false" id="profileDropdown"
                                    aria-label="User profile menu">
                                    <i class="fa-solid fa-user" aria-hidden="true"></i>
                                    <span class="tw-hidden xl:tw-inline">
                                        <%= __('profile') %>
                                    </span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end tw-glass-dark tw-border tw-border-white/20 tw-rounded-2xl tw-p-2 tw-min-w-[250px]"
                                    aria-labelledby="profileDropdown">
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/profile"><i class="fa-solid fa-user tw-mr-2"></i>My Profile</a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/profile/wishlist"><i class="fa-solid fa-bookmark tw-mr-2"></i>My
                                            Wishlist</a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/profile/likes"><i class="fa-solid fa-heart tw-mr-2"></i>Liked
                                            Listings</a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/profile/vacation-slots">
                                            <i class="fa-solid fa-calendar-check tw-mr-2"></i>My Vacation Slots
                                            <% if (currentUser && currentUser.vacationSlots &&
                                                currentUser.vacationSlots.length> 0) { %>
                                                <span class="tw-badge tw-bg-coral tw-ml-2">
                                                    <%= currentUser.vacationSlots.length %>
                                                </span>
                                                <% } %>
                                        </a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/trip-planner/my-trips"><i
                                                class="fa-solid fa-suitcase-rolling tw-mr-2"></i>My Trip Plans</a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/phrase-assistant"><i class="fa-solid fa-language tw-mr-2"></i>Phrase
                                            Assistant</a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/profile/travel-journal"><i
                                                class="fa-solid fa-book tw-mr-2"></i>Travel Journal</a></li>
                                    <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                            href="/trip-planner/offline-trips">
                                            <i class="fa-solid fa-download tw-mr-2"></i>My Downloads
                                            <span id="profileDownloadCount" class="tw-badge tw-bg-aqua tw-ml-2"
                                                style="display: none;">0</span>
                                        </a></li>
                                    <% if (currentUser && currentUser.isAdmin) { %>
                                        <li>
                                            <hr class="tw-border-white/10">
                                        </li>
                                        <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                                href="/admin/dashboard"><i
                                                    class="fa-solid fa-chart-line tw-mr-2"></i>Admin Dashboard</a></li>
                                        <% } %>
                                            <li>
                                                <hr class="tw-border-white/10">
                                            </li>
                                            <li><a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition"
                                                    href="/logout"><i class="fa-solid fa-sign-out-alt tw-mr-2"></i>
                                                    <%= __('logout') %>
                                                </a></li>
                                </ul>
                            </div>

                            <!-- Notifications -->
                            <div class="dropdown">
                                <button class="tw-btn-glass tw-text-white tw-text-sm tw-px-3 tw-py-2 tw-relative"
                                    data-bs-toggle="dropdown" aria-expanded="false" id="notificationToggle"
                                    aria-label="View notifications">
                                    <i class="fa-solid fa-bell" aria-hidden="true"></i>
                                    <span id="notificationBadge"
                                        class="tw-absolute tw--top-1 tw--right-1 tw-bg-coral tw-text-white tw-text-xs tw-rounded-full tw-px-1.5 tw-py-0.5 tw-min-w-[18px] tw-text-center"
                                        style="display: none;">0</span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end tw-glass-dark tw-border tw-border-white/20 tw-rounded-2xl tw-p-0 tw-w-[350px]"
                                    aria-labelledby="notificationToggle">
                                    <div
                                        class="tw-p-4 tw-border-b tw-border-white/10 tw-flex tw-justify-between tw-items-center">
                                        <h6 class="tw-text-white tw-font-bold tw-mb-0">Notifications</h6>
                                        <button id="markAllRead"
                                            class="tw-text-aqua tw-text-sm hover:tw-text-coral tw-transition"
                                            type="button">Mark All Read</button>
                                    </div>
                                    <div id="notificationList" class="tw-max-h-[350px] tw-overflow-y-auto">
                                        <div class="tw-text-center tw-text-white/60 tw-p-8" id="noNotifications">
                                            <i class="fa-solid fa-bell-slash tw-text-4xl tw-mb-3"
                                                aria-hidden="true"></i>
                                            <p class="tw-mb-0 tw-text-sm">No notifications yet</p>
                                        </div>
                                    </div>
                                    <div class="tw-p-3 tw-border-t tw-border-white/10 tw-text-center">
                                        <a href="/notifications"
                                            class="tw-text-aqua tw-text-sm hover:tw-text-coral tw-transition">View All
                                            Notifications</a>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                                <!-- Language Selector -->
                                <div class="dropdown">
                                    <button
                                        class="tw-btn-glass tw-text-white tw-text-sm tw-px-3 tw-py-2 tw-flex tw-items-center tw-gap-2"
                                        data-bs-toggle="dropdown" aria-expanded="false" id="languageToggle"
                                        aria-label="Select language">
                                        <span>
                                            <%= languageMap[getLocale()].flag %>
                                        </span>
                                        <span class="tw-hidden xl:tw-inline">
                                            <%= languageMap[getLocale()].name %>
                                        </span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end tw-glass-dark tw-border tw-border-white/20 tw-rounded-2xl tw-p-2"
                                        aria-labelledby="languageToggle">
                                        <% Object.keys(languageMap).forEach(lang=> { %>
                                            <li>
                                                <a class="dropdown-item tw-text-white hover:tw-bg-white/10 tw-rounded-lg tw-transition <%= getLocale() === lang ? 'tw-bg-white/20' : '' %>"
                                                    href="<%= buildLangUrl(lang) %>">
                                                    <%= languageMap[lang].flag %>
                                                        <%= languageMap[lang].name %>
                                                </a>
                                            </li>
                                            <% }); %>
                                    </ul>
                                </div>

                                <!-- Theme Toggle -->
                                <%- include("../includes/theme-toggle.ejs") %>
                </div>
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="lg:tw-hidden tw-text-white tw-text-2xl" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#mobileMenu" aria-controls="mobileMenu" aria-label="Toggle navigation menu">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Mobile Menu (Offcanvas) -->
<div class="offcanvas offcanvas-end tw-glass-dark tw-border-l tw-border-white/20 tw-w-[300px]" tabindex="-1"
    id="mobileMenu" aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header tw-border-b tw-border-white/10">
        <h5 class="offcanvas-title tw-text-white tw-font-bold" id="mobileMenuLabel">Menu</h5>
        <button type="button" class="tw-text-white tw-text-2xl" data-bs-dismiss="offcanvas" aria-label="Close">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>
    <div class="offcanvas-body tw-p-4">
        <!-- Mobile Search -->
        <form method="GET" action="/listings" class="tw-mb-6">
            <div class="tw-search-glass tw-flex tw-items-center tw-px-3 tw-gap-2">
                <i class="fa-solid fa-magnifying-glass tw-text-white/60"></i>
                <input type="search" name="search" placeholder="<%= __('search_destinations') %>"
                    class="tw-bg-transparent tw-border-0 tw-text-white tw-placeholder-white/60 tw-outline-none tw-flex-1 tw-py-2 tw-text-sm" />
            </div>
        </form>

        <!-- Mobile Nav Links -->
        <div class="tw-space-y-2 tw-mb-6">
            <a href="/listings"
                class="tw-block tw-text-white tw-font-medium tw-py-3 tw-px-4 tw-rounded-xl hover:tw-bg-white/10 tw-transition">
                <i class="fa-regular fa-copy tw-mr-3"></i>
                <%= __('all_listings') %>
            </a>
            <a href="/listings/about"
                class="tw-block tw-text-white tw-font-medium tw-py-3 tw-px-4 tw-rounded-xl hover:tw-bg-white/10 tw-transition">
                <i class="fa-solid fa-info-circle tw-mr-3"></i>
                <%= __('about') %>
            </a>
            <a href="/listings/new"
                class="tw-block tw-text-white tw-font-medium tw-py-3 tw-px-4 tw-rounded-xl hover:tw-bg-white/10 tw-transition">
                <i class="fa-solid fa-plus tw-mr-3"></i>
                <%= __('add_new_listing') %>
            </a>
        </div>

        <% if (typeof currentUser==='undefined' || !currentUser) { %>
            <!-- Mobile Auth Buttons -->
            <div class="tw-space-y-3">
                <a href="/login" class="tw-block tw-btn-glass tw-text-white tw-text-center tw-py-3">
                    <i class="fa-solid fa-sign-in-alt tw-mr-2"></i>
                    <%= __('login') %>
                </a>
                <a href="/signup" class="tw-block tw-btn-gradient tw-text-center tw-py-3">
                    <i class="fa-solid fa-user-plus tw-mr-2"></i>
                    <%= __('signup') %>
                </a>
            </div>
            <% } else { %>
                <!-- Mobile User Menu -->
                <div class="tw-space-y-2">
                    <a href="/profile"
                        class="tw-block tw-text-white tw-py-2 tw-px-4 tw-rounded-xl hover:tw-bg-white/10 tw-transition tw-text-sm">
                        <i class="fa-solid fa-user tw-mr-3"></i>My Profile
                    </a>
                    <a href="/profile/wishlist"
                        class="tw-block tw-text-white tw-py-2 tw-px-4 tw-rounded-xl hover:tw-bg-white/10 tw-transition tw-text-sm">
                        <i class="fa-solid fa-bookmark tw-mr-3"></i>My Wishlist
                    </a>
                    <a href="/logout"
                        class="tw-block tw-text-white tw-py-2 tw-px-4 tw-rounded-xl hover:tw-bg-white/10 tw-transition tw-text-sm">
                        <i class="fa-solid fa-sign-out-alt tw-mr-3"></i>
                        <%= __('logout') %>
                    </a>
                </div>
                <% } %>
    </div>
</div>

<!-- Existing Scripts (from original navbar) -->
<% if (typeof currentUser !=='undefined' && currentUser) { %>
    <script>
        (function () {
            'use strict';
            document.addEventListener('DOMContentLoaded', function () {
                if (window.OfflineManager) {
                    initializeDownloadsDropdown();
                }
                if (typeof currentUser !== 'undefined' && currentUser) {
                    window.notificationManager = new NotificationManager();
                }
            });

            async function initializeDownloadsDropdown() {
                try {
                    const trips = await window.OfflineManager.getStoredPdfs();
                    updateDownloadsBadge(trips);
                } catch (error) {
                    console.error('Error initializing downloads:', error);
                }
            }

            function updateDownloadsBadge(trips) {
                const badge = document.getElementById('profileDownloadCount');
                if (!badge) return;
                if (trips && trips.length > 0) {
                    badge.textContent = trips.length;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }

            window.viewDownloadedTrip = async function (tripId) {
                try {
                    if (!window.OfflineManager) return;
                    const pdfData = await window.OfflineManager.getTripPdf(tripId);
                    if (pdfData) {
                        const blob = new Blob([pdfData], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        window.open(url, '_blank');
                    } else {
                        showToast('PDF not found', 'error');
                    }
                } catch (error) {
                    console.error('Error viewing downloaded trip:', error);
                    showToast('Failed to open PDF', 'error');
                }
            };

            class NotificationManager {
                constructor() {
                    this.notifications = [];
                    this.unreadCount = 0;
                    this.isInitialized = false;
                    this.init();
                }

                async init() {
                    if (this.isInitialized) return;
                    try {
                        await this.loadNotifications();
                        this.setupEventListeners();
                        this.isInitialized = true;
                    } catch (error) {
                        console.error('Failed to initialize notifications:', error);
                    }
                }

                async loadNotifications() {
                    try {
                        const response = await fetch('/trip-planner/api/notifications');
                        if (response.ok) {
                            this.notifications = await response.json();
                            this.updateUnreadCount();
                            this.renderNotifications();
                        }
                    } catch (error) {
                        console.error('Failed to load notifications:', error);
                    }
                }

                updateUnreadCount() {
                    this.unreadCount = this.notifications.filter(n => !n.isRead).length;
                    this.updateBadge();
                }

                updateBadge() {
                    const badge = document.getElementById('notificationBadge');
                    if (!badge) return;
                    if (this.unreadCount > 0) {
                        badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                renderNotifications() {
                    const container = document.getElementById('notificationList');
                    const noNotifications = document.getElementById('noNotifications');
                    if (!container) return;
                    if (this.notifications.length === 0) {
                        if (noNotifications) noNotifications.style.display = 'block';
                        return;
                    }
                    if (noNotifications) noNotifications.style.display = 'none';
                    const recentNotifications = this.notifications.slice(0, 5);
                    container.innerHTML = recentNotifications.map(n => this.createNotificationHTML(n)).join('');
                }

                createNotificationHTML(notification) {
                    const timeAgo = this.getTimeAgo(notification.createdAt);
                    const unreadClass = notification.isRead ? '' : 'tw-bg-white/5';
                    return `
            <div class="tw-p-3 tw-border-b tw-border-white/10 ${unreadClass} hover:tw-bg-white/10 tw-transition tw-cursor-pointer" data-id="${notification._id}">
              <div class="tw-flex tw-justify-between tw-items-start">
                <div class="tw-flex-grow">
                  <h6 class="tw-text-white tw-font-bold tw-mb-1 tw-text-sm">${this.escapeHtml(notification.title)}</h6>
                  <p class="tw-text-white/70 tw-mb-1 tw-text-xs">${this.escapeHtml(notification.message)}</p>
                  <small class="tw-text-white/50 tw-text-xs">${timeAgo}</small>
                </div>
                <div class="tw-ml-2 tw-flex tw-flex-col tw-gap-1">
                  ${!notification.isRead ? `
                    <button class="tw-text-green-400 hover:tw-text-green-300 tw-transition" onclick="event.stopPropagation(); window.notificationManager.markAsRead('${notification._id}')" title="Mark as read" aria-label="Mark as read">
                      <i class="fa-solid fa-check"></i>
                    </button>
                  ` : ''}
                  <button class="tw-text-red-400 hover:tw-text-red-300 tw-transition" onclick="event.stopPropagation(); window.notificationManager.deleteNotification('${notification._id}')" title="Delete" aria-label="Delete notification">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
                }

                escapeHtml(text) {
                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                    return String(text).replace(/[&<>"']/g, m => map[m]);
                }

                getTimeAgo(dateString) {
                    const now = new Date();
                    const date = new Date(dateString);
                    const diffInSeconds = Math.floor((now - date) / 1000);
                    if (diffInSeconds < 60) return 'Just now';
                    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                    return `${Math.floor(diffInSeconds / 86400)}d ago`;
                }

                setupEventListeners() {
                    const markAllReadBtn = document.getElementById('markAllRead');
                    if (markAllReadBtn) {
                        markAllReadBtn.addEventListener('click', () => this.markAllAsRead());
                    }
                }

                async markAsRead(notificationId) {
                    try {
                        const response = await fetch(`/trip-planner/api/notifications/${notificationId}/read`, { method: 'PATCH' });
                        if (response.ok) {
                            const notification = this.notifications.find(n => n._id === notificationId);
                            if (notification) {
                                notification.isRead = true;
                                this.updateUnreadCount();
                                this.renderNotifications();
                            }
                        }
                    } catch (error) {
                        console.error('Failed to mark notification as read:', error);
                        showToast('Failed to mark notification as read', 'error');
                    }
                }

                async markAllAsRead() {
                    try {
                        const unreadNotifications = this.notifications.filter(n => !n.isRead);
                        await Promise.all(unreadNotifications.map(n => this.markAsRead(n._id)));
                        showToast('All notifications marked as read', 'success');
                    } catch (error) {
                        console.error('Failed to mark all notifications as read:', error);
                        showToast('Failed to mark all notifications as read', 'error');
                    }
                }

                async deleteNotification(notificationId) {
                    try {
                        const response = await fetch(`/trip-planner/api/notifications/${notificationId}`, { method: 'DELETE' });
                        if (response.ok) {
                            this.notifications = this.notifications.filter(n => n._id !== notificationId);
                            this.updateUnreadCount();
                            this.renderNotifications();
                            showToast('Notification deleted', 'success');
                        }
                    } catch (error) {
                        console.error('Failed to delete notification:', error);
                        showToast('Failed to delete notification', 'error');
                    }
                }

                addNotification(notification) {
                    this.notifications.unshift(notification);
                    this.updateUnreadCount();
                    this.renderNotifications();
                    showToast(notification.title, 'info');
                }
            }

            window.showToast = function (message, type = 'info') {
                const alertClass = { 'success': 'alert-success', 'error': 'alert-danger', 'info': 'alert-info', 'warning': 'alert-warning' }[type] || 'alert-info';
                const iconClass = { 'success': 'fa-check-circle', 'error': 'fa-times-circle', 'info': 'fa-info-circle', 'warning': 'fa-exclamation-circle' }[type] || 'fa-info-circle';
                const toast = document.createElement('div');
                toast.className = `alert ${alertClass} position-fixed shadow-lg`;
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease-out;';
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `<div class="d-flex align-items-center"><i class="fa-solid ${iconClass} me-2"></i><span>${message}</span></div>`;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };
        })();
    </script>
    <% } %>

        <style>
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }

                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }

                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }

            .tw-animate-spin-slow {
                animation: spin 3s linear infinite;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            /* Search suggestions positioning */
            .search-suggestions {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                z-index: 1050;
                max-height: 300px;
                overflow-y: auto;
                margin-top: 8px;
            }
        </style>