<% layout("/layouts/boilerplate") %>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="trips-header mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h2 class="mb-1">
                            <i class="fa-solid fa-suitcase-rolling text-primary me-2"></i>
                            My Trip Plans
                        </h2>
                        <p class="text-muted mb-0">Your saved trips and budget estimates</p>
                    </div>
                    <a href="/trip-planner" class="btn btn-primary">
                        <i class="fa-solid fa-plus me-1"></i>
                        Plan New Trip
                    </a>
                </div>
            </div>

            <% if (trips && trips.length > 0) { %>
                <!-- Trip Analytics Dashboard -->
                <div class="analytics-dashboard mb-5">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-suitcase-rolling text-primary"></i>
                                </div>
                                <div class="stat-content">
                                    <h4><%= analytics.totalTrips %></h4>
                                    <p>Total Trips</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-dollar-sign text-success"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>$<%= analytics.totalBudget.toLocaleString() %></h4>
                                    <p>Total Budget</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-chart-line text-info"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>$<%= analytics.averageTripCost.toLocaleString() %></h4>
                                    <p>Avg Trip Cost</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-calendar-check text-warning"></i>
                                </div>
                                <div class="stat-content">
                                    <h4><%= analytics.upcomingTrips %></h4>
                                    <p>Upcoming Trips</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Favorite Destinations -->
                    <% if (analytics.favoriteDestinations && analytics.favoriteDestinations.length > 0) { %>
                        <div class="favorite-destinations mt-4">
                            <h5><i class="fa-solid fa-heart text-danger me-2"></i>Favorite Destinations</h5>
                            <div class="row">
                                <% analytics.favoriteDestinations.forEach(dest => { %>
                                    <div class="col-md-4 mb-2">
                                        <div class="destination-badge">
                                            <i class="fa-solid fa-map-marker-alt me-2"></i>
                                            <%= dest.destination %> 
                                            <span class="badge bg-primary ms-2"><%= dest.count %></span>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>
                </div>

                <div class="row">
                    <% trips.forEach(trip => { %>
                        <div class="col-lg-6 mb-4">
                            <div class="trip-card">
                                <div class="trip-header">
                                    <div class="trip-destination">
                                        <h4><i class="fa-solid fa-map-marker-alt me-2"></i><%= trip.destination %></h4>
                                        <div class="trip-dates">
                                            <i class="fa-solid fa-calendar me-1"></i>
                                            <%= new Date(trip.startDate).toLocaleDateString() %> - 
                                            <%= new Date(trip.endDate).toLocaleDateString() %>
                                        </div>
                                    </div>
                                    <div class="trip-actions">
                                        <button class="btn btn-sm btn-outline-danger delete-trip-btn" 
                                                data-trip-id="<%= trip._id %>">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="trip-details">
                                    <div class="trip-meta">
                                        <span class="badge bg-primary me-2">
                                            <i class="fa-solid fa-users me-1"></i>
                                            <%= trip.travelers %> travelers
                                        </span>
                                        <span class="badge bg-secondary me-2">
                                            <%= trip.budgetType.charAt(0).toUpperCase() + trip.budgetType.slice(1) %>
                                        </span>
                                        <span class="badge bg-<%= trip.status === 'planned' ? 'warning' : trip.status === 'booked' ? 'info' : 'success' %>">
                                            <%= trip.status.charAt(0).toUpperCase() + trip.status.slice(1) %>
                                        </span>
                                        <% if (new Date(trip.startDate) > new Date()) { %>
                                            <span class="badge bg-success ms-1">
                                                <i class="fa-solid fa-clock me-1"></i>Upcoming
                                            </span>
                                        <% } %>
                                    </div>

                                    <div class="cost-summary mt-3">
                                        <div class="total-cost-display">
                                            <span class="cost-amount">$<%= trip.total.toLocaleString() %></span>
                                            <span class="cost-label">Total Cost</span>
                                        </div>
                                        <div class="per-person-cost">
                                            $<%= Math.round(trip.total / trip.travelers).toLocaleString() %> per person
                                        </div>
                                    </div>

                                    <div class="cost-breakdown-mini mt-3">
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-plane text-primary"></i>
                                            $<%= trip.costs.flights.toLocaleString() %>
                                        </div>
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-bed text-success"></i>
                                            $<%= trip.costs.hotels.toLocaleString() %>
                                        </div>
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-utensils text-warning"></i>
                                            $<%= trip.costs.food.toLocaleString() %>
                                        </div>
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-camera text-info"></i>
                                            $<%= trip.costs.activities.toLocaleString() %>
                                        </div>
                                    </div>
                                </div>

                                <div class="trip-footer">
                                    <small class="text-muted">
                                        <i class="fa-solid fa-clock me-1"></i>
                                        Planned on <%= new Date(trip.createdAt).toLocaleDateString() %>
                                    </small>
                                    <div class="trip-actions-footer">
                                        <div class="btn-group" role="group">
                                            <a href="/trip-planner?destination=<%= encodeURIComponent(trip.destination) %>" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fa-solid fa-edit me-1"></i>
                                                Modify
                                            </a>
                                            <button class="btn btn-sm btn-outline-success update-status-btn" 
                                                    data-trip-id="<%= trip._id %>" 
                                                    data-current-status="<%= trip.status %>">
                                                <i class="fa-solid fa-check me-1"></i>
                                                Update Status
                                            </button>
                                            <button class="btn btn-sm btn-outline-info share-trip-btn" 
                                                    data-trip-id="<%= trip._id %>">
                                                <i class="fa-solid fa-share me-1"></i>
                                                Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="empty-state text-center py-5">
                    <div class="empty-icon mb-4">
                        <i class="fa-solid fa-route fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Trip Plans Yet</h4>
                    <p class="text-muted mb-4">
                        Start planning your dream vacation with instant budget estimates!
                    </p>
                    <div class="empty-actions">
                        <a href="/trip-planner" class="btn btn-primary btn-lg me-3">
                            <i class="fa-solid fa-plus me-2"></i>
                            Plan Your First Trip
                        </a>
                        <a href="/listings" class="btn btn-outline-primary btn-lg">
                            <i class="fa-solid fa-compass me-2"></i>
                            Explore Destinations
                        </a>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<style>
.trip-card {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    height: 100%;
}

.trip-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.trip-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.trip-destination h4 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.trip-dates {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.trip-meta {
    margin-bottom: 1rem;
}

.cost-summary {
    background: rgba(254, 66, 77, 0.1);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
}

.cost-amount {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent-color);
}

.cost-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.per-person-cost {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.cost-breakdown-mini {
    display: flex;
    justify-content: space-around;
    gap: 0.5rem;
}

.cost-item-mini {
    text-align: center;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.cost-item-mini i {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
}

.trip-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.empty-state {
    background: rgba(108, 117, 125, 0.05);
    border-radius: 15px;
    margin: 2rem 0;
    padding: 3rem;
}

.analytics-dashboard {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    height: 100%;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.stat-content h4 {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.stat-content p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.9rem;
}

.favorite-destinations {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 1.5rem;
}

.destination-badge {
    background: rgba(254, 66, 77, 0.1);
    border: 1px solid rgba(254, 66, 77, 0.2);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.btn-group .btn {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
}

@media (max-width: 768px) {
    .trip-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .cost-breakdown-mini {
        flex-wrap: wrap;
    }
    
    .trip-footer {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle delete trip
    document.querySelectorAll('.delete-trip-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const tripId = this.dataset.tripId;
            
            if (confirm('Are you sure you want to delete this trip plan?')) {
                try {
                    const response = await fetch(`/trip-planner/${tripId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete trip');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete trip');
                }
            }
        });
    });
    
    // Handle update trip status
    document.querySelectorAll('.update-status-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const tripId = this.dataset.tripId;
            const currentStatus = this.dataset.currentStatus;
            
            const statusOptions = {
                'planned': 'booked',
                'booked': 'completed',
                'completed': 'planned'
            };
            
            const newStatus = statusOptions[currentStatus];
            const statusLabels = {
                'planned': 'Planned',
                'booked': 'Booked',
                'completed': 'Completed'
            };
            
            if (confirm(`Update trip status to "${statusLabels[newStatus]}"?`)) {
                try {
                    const response = await fetch(`/trip-planner/${tripId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Failed to update trip status');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to update trip status');
                }
            }
        });
    });
    
    // Handle share trip
    document.querySelectorAll('.share-trip-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tripCard = this.closest('.trip-card');
            const destination = tripCard.querySelector('h4').textContent.replace('🗺️ ', '');
            const dates = tripCard.querySelector('.trip-dates').textContent.replace('📅 ', '');
            const totalCost = tripCard.querySelector('.cost-amount').textContent;
            
            const shareText = `Check out my trip plan!\n` +
                             `📍 Destination: ${destination}\n` +
                             `📅 Dates: ${dates}\n` +
                             `💰 Total Cost: ${totalCost}\n` +
                             `Plan your trip at: ${window.location.origin}/trip-planner`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Trip to ${destination} - WanderLust`,
                    text: shareText,
                    url: window.location.origin + '/trip-planner'
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Trip details copied to clipboard!');
                }).catch(() => {
                    alert('Unable to copy to clipboard. Please copy manually:\n\n' + shareText);
                });
            }
        });
    });
});
</script>